package bj9376_탈옥;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.util.*;

public class Main {

    static int N, M;

    static class Point {
        int y;
        int x;
        Set<String> set;

        public Point(int y, int x, Set<String> set) {
            this.y = y;
            this.x = x;
            this.set = new HashSet<>(set);
        }
    }

    public static void main(String[] args) throws IOException {
        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));
        br = new BufferedReader(new StringReader(TC4));
        int T = Integer.parseInt(br.readLine());
        for (int tc = 1; tc <= T; tc++) {

            StringTokenizer st = new StringTokenizer(br.readLine());

            N = Integer.parseInt(st.nextToken());
            M = Integer.parseInt(st.nextToken());

            char map[][] = new char[N][M];

            int[][] start = new int[2][2];
            int startIdx = 0;


            for (int i = 0; i < N; i++) {
                String input = br.readLine();
                char[] arr = input.toCharArray();
                for (int j = 0; j < M; j++) {
                    if (arr[j] == '$') {
                        map[i][j] = '.';
                        start[startIdx][0] = i;
                        start[startIdx][1] = j;
                        startIdx++;
                    } else
                        map[i][j] = arr[j];
                }
            }


//            for (int i = 0; i < N; i++) {
//                System.out.println();
//                for (int j = 0; j < M; j++) {
//                    System.out.print(map[i][j]);
//                }
//            }


            // set으로 bfs 두번돌려

            int answer = Integer.MAX_VALUE;

            Queue<Point> q = new LinkedList<>();
            q.add(new Point(start[0][0], start[0][1], new HashSet<String>()));

            boolean[][][] visited = new boolean[N][M][10000];
            visited[start[0][0]][start[0][1]][0] = true;

            while (!q.isEmpty()) {

                Point p = q.poll();

                if (p.set.size() >= answer)
                    continue;

                // 한놈이 나갔으면 다른놈으로 돌려
                if (isFinish(p.y, p.x)) {
//                    System.out.println("1차 끝난 size : " + p.set.size());
//                    System.out.println(p.y + " " + p.x + " ");
//                    for(String s : p.set){
//                        System.out.println(s);
//                    }
//                    System.out.println();
                    Queue<Point> q2 = new LinkedList<>();
                    q2.add(new Point(start[1][0], start[1][1], p.set));

                    boolean[][][] visited2 = new boolean[N][M][10000];
                    visited2[start[1][0]][start[1][1]][p.set.size()] = true;

                    while (!q2.isEmpty()) {

                        Point p2 = q2.poll();

                        if (p2.set.size() >= answer)
                            continue;

                        if (isFinish(p2.y, p2.x)) {
                            answer = Integer.min(answer, p2.set.size());

                        } else {

                            for (int d2 = 0; d2 < 4; d2++) {
                                int ny2 = p2.y + dy[d2];
                                int nx2 = p2.x + dx[d2];

                                if (outRange(ny2, nx2) || visited2[ny2][nx2][p2.set.size()] || map[ny2][nx2] == '*')
                                    continue;

                                visited2[ny2][nx2][p2.set.size()] = true;

                                if (p.set.contains(ny2 + nx2 + "")) {
//                                    System.out.println();
//                                    System.out.println("현재 1번 탈출 위치 " + p.y + " " + p.x);
//                                    System.out.println(ny2 + " " + nx2 + " " + "는 이미 방문함, size = " + p2.set.size());
                                    answer = Integer.min(answer, p2.set.size());
                                } else {
                                    Point next2 = new Point(ny2, nx2, p2.set);
                                    if (map[ny2][nx2] == '#')
                                        next2.set.add(ny2 + " " + nx2);

                                    q2.add(next2);
                                }
                            }
                        }
                    }
                } else {

                    for (int d = 0; d < 4; d++) {
                        int ny = p.y + dy[d];
                        int nx = p.x + dx[d];

                        if (outRange(ny, nx) || visited[ny][nx][p.set.size()] || map[ny][nx] == '*')
                            continue;

                        visited[ny][nx][p.set.size()] = true;
                        Point next = new Point(ny, nx, p.set);
                        if (map[ny][nx] == '#')
                            next.set.add(ny + " " + nx);
                        q.add(next);
                    }
                }

            }

            System.out.println(answer);


        }
    }

    static int[] dy = {-1, 1, 0, 0};
    static int[] dx = {0, 0, -1, 1};

    static boolean outRange(int y, int x) {
        return y < 0 || x < 0 || y >= N || x >= M;
    }

    static boolean isFinish(int y, int x) {
        return y == 0 || x == 0 || y == N - 1 || x == M - 1;
    }

    static String TC0 = "1\n" +
            "5 5\n" +
            "#####\n" +
            "....#\n" +
            "###.#\n" +
            "#$$.#\n" +
            "#####";
    static String TC1 = "3\n" +
            "5 9\n" +
            "****#****\n" +
            "*..#.#..*\n" +
            "****.****\n" +
            "*$#.#.#$*\n" +
            "*********\n" +
            "5 11\n" +
            "*#*********\n" +
            "*$*...*...*\n" +
            "*$*.*.*.*.*\n" +
            "*...*...*.*\n" +
            "*********.*\n" +
            "9 9\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**.**#*\n" +
            "*#*#.#*#*\n" +
            "*$##*##$*\n" +
            "*#*****#*\n" +
            "*.#.#.#.*\n" +
            "*********";
    static String TC2 = "1\n" +
            "9 9\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**.**#*\n" +
            "*#*#.#*#*\n" +
            "*$##*##$*\n" +
            "*#*****#*\n" +
            "*.#.#.#.*\n" +
            "*********";

    static String TC3 = "6\n" +
            "5 9\n" +
            "****#****\n" +
            "*..#.#..*\n" +
            "****.****\n" +
            "*$#.#.#$*\n" +
            "*********\n" +
            "5 11\n" +
            "*#*********\n" +
            "*$*...*...*\n" +
            "*$*.*.*.*.*\n" +
            "*...*...*.*\n" +
            "*********.*\n" +
            "9 9\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**.**#*\n" +
            "*#*#.#*#*\n" +
            "*$##*##$*\n" +
            "*#*****#*\n" +
            "*.#.#.#.*\n" +
            "*********\n" +
            "2 2\n" +
            ".$\n" +
            "$#\n" +
            "10 13\n" +
            "*#****#****#*\n" +
            "*#****.****#*\n" +
            "*#****#****#*\n" +
            "*#****.****#*\n" +
            "*#****#****#*\n" +
            "*#****.****#*\n" +
            "*.###.#.###.*\n" +
            "*$*********$*\n" +
            "*.#.#.#.#.#.*\n" +
            "*************\n" +
            "5 10\n" +
            "**********\n" +
            "*.#.##.#.*\n" +
            ".#*$**$*#.\n" +
            "*.#.##.#.*\n" +
            "**********";
    static String TC4 = "4\n" +
            "41 100\n" +
            "****************************************************************************************************\n" +
            "###################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*##################################################################################################*\n" +
            "*#**************************************************************************************************\n" +
            "*##################################################################################################*\n" +
            "**************************************************************************************************#*\n" +
            "*$$################################################################################################*\n" +
            "****************************************************************************************************\n" +
            "41 100\n" +
            "####################################################################################################\n" +
            "...................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#$$................................................................................................#\n" +
            "####################################################################################################\n" +
            "100 100\n" +
            "****************************************************************************************************\n" +
            "*################################$#################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*#################################################################################################$*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "*##################################################################################################*\n" +
            "###################################################################################################*\n" +
            "****************************************************************************************************\n" +
            "9 9\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**#**#*\n" +
            "*#**.**#*\n" +
            "*#*#.#*#*\n" +
            "*$##*##$*\n" +
            "*#*****#*\n" +
            "*.......*\n" +
            "*********";

    static String TC5 = "1\n" +
            "41 100\n" +
            "####################################################################################################\n" +
            "...................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#..................................................................................................#\n" +
            "#.##################################################################################################\n" +
            "#..................................................................................................#\n" +
            "##################################################################################################.#\n" +
            "#$$................................................................................................#\n" +
            "####################################################################################################";
}
